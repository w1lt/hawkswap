{% extends 'base.html' %} {% block title %}Chat | HawkSwap{% endblock %} {%
block content %}

<h2>{{listing_name}} - ${{price}}</h2>
<div id="message-list"></div>

<form id="message-form">
  <input
    type="text"
    id="message"
    name="message"
    autofocus
    required
    autocomplete="off"
  />
  <button type="button" id="chatbox" onclick="sendMessage()">Send</button>
  <script>
    document.getElementById("message-form").addEventListener("submit", (e) => {
      e.preventDefault();
    });
    document.getElementById("message").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        //if message is blank, do nothing
        if (document.getElementById("message").value == "") {
          return;
        }
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</form>

<script>
  function fetchMessages() {
    fetch("/get_messages/{{ chat_id }}")
      .then((response) => response.json())
      .then((data) => {
        let messageList = document.getElementById("message-list");
        messageList.innerHTML = ""; // Clear existing messages

        // Determine the last message index sent by the current user
        let lastSentMessageIndex = -1;
        data.forEach((message, index) => {
          if (message.username == "{{ current_user.username }}") {
            lastSentMessageIndex = index;
          }
        });

        data.forEach((message, index) => {
          let li = document.createElement("li");
          li.className =
            message.username == "{{ current_user.username }}"
              ? "message user-message"
              : "message";

          let messageContent = document.createElement("span");
          messageContent.textContent =
            (message.username == "{{ current_user.username }}"
              ? ""
              : message.username + ": ") + message.message_content;
          li.appendChild(messageContent);

          // Append status indicator only to the latest message sent by the current user
          if (index === lastSentMessageIndex) {
            let statusIndicator = document.createElement("span");
            statusIndicator.style.marginLeft = "10px"; // Add some space between the message and the status

            if (message.read_status) {
              let checkIcon = document.createElement("i");
              checkIcon.className = "fas fa-check"; // Font Awesome check icon
              checkIcon.style.color = "green"; // Color the icon
              statusIndicator.appendChild(checkIcon);
            } else {
              statusIndicator.textContent = "sent";
              statusIndicator.style.color = "gray"; // Color the text
            }

            li.appendChild(statusIndicator);
          }

          messageList.appendChild(li);
        });
      });
  }

  function scrollToChat() {
    var element = document.getElementById("chatbox");
    element.scrollIntoView({ behavior: "smooth" });
  }

  function sendMessage() {
    let messageInput = document.getElementById("message");
    let message = messageInput.value;
    messageInput.value = ""; // Clear the input after sending
    fetch("/chat/{{ chat_id }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ message: message }),
    }).then(() => {
      fetchMessages(); // Refresh messages
    });
    scrollToChat();
  }

  // Fetch messages every 5 seconds
  setInterval(fetchMessages, 3000);

  // Fetch messages when the page loads
  document.addEventListener("DOMContentLoaded", fetchMessages);
  //wait half a second and scroll to the bottom of the chat
  setTimeout(scrollToChat, 100);
</script>

{% endblock %}
